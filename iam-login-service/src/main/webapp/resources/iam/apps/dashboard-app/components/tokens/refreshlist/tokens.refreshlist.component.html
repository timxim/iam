<!--

    Copyright (c) Istituto Nazionale di Fisica Nucleare (INFN). 2016-2019

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<!-- Current Active Refresh Tokens Box -->
<div class="box box-primary" id="refresh-tokens-list">
    <div class="box-header with-border">

        <div class="row">
            <div class="col-md-5">
                <ui-select id="rtok_client_search_btn" ng-model="$ctrl.clientSelected" theme="bootstrap" sortable="true" close-on-select="true" input-id="rtok_client_search" style="width: 100%;" on-select="$ctrl.searchTokens(1)">
                    <ui-select-match allow-clear="true" placeholder="Filter tokens by client...">{{$ctrl.clientSelected.clientId}}</ui-select-match>
                    <ui-select-choices repeat="client in $ctrl.clients | filter: {clientId: $select.search}">
                        <div ng-bind-html="client.clientId | highlight: $select.search"></div>
                        <small> {{ client.clientName }} </small>
                    </ui-select-choices>
                    <ui-select-no-choice> No results found </ui-select-no-choice>
                </ui-select>
            </div>
            <div class="col-md-5">
                <ui-select id="rtok_user_search_btn" ng-model="$ctrl.userSelected" theme="bootstrap" sortable="true" close-on-select="true" input-id="rtok_user_search" style="width: 100%;" on-select="$ctrl.searchTokens(1)">
                    <ui-select-match allow-clear="true" placeholder="Filter tokens by user...">{{$ctrl.userSelected.name.formatted}}</ui-select-match>
                    <ui-select-choices repeat="user in $ctrl.users | filter: {userName: $select.search}">
                        <div ng-bind-html="user.userName | highlight: $select.search"></div>
                        <small>{{ user.id }}</small>
                    </ui-select-choices>
                    <ui-select-no-choice> No results found </ui-select-no-choice>
                </ui-select>
            </div>
            <div class="col-md-2 text-right">
                <button class="btn btn-default" id="refresh_rtoken_list" ng-click="$ctrl.searchTokens(1)"><i class="fa fa-refresh"></i></button>
            </div>
        </div>
    </div>
    <div class="box-body">

        <div class="text-center" ng-if="$ctrl.clientSelected !== undefined || $ctrl.userSelected !== undefined">
            <p>Found <span id="rtoken_filtered"><strong>{{$ctrl.totalResults}}</strong></span> tokens matching filter (out of <strong>{{$root.refreshTokensCount}}</strong>)</p>
        </div>

        <div ng-if="!$ctrl.tokens.length && !($ctrl.clientSelected !== undefined || $ctrl.userSelected !== undefined)">
            No active refresh tokens found
        </div>

        <div class="table-responsive" ng-if="$ctrl.tokens.length">

            <div class="text-center">
                <ul id="rtoken_pagination_top" uib-pagination ng-model="$ctrl.currentPage" items-per-page="$ctrl.itemsPerPage" total-items="$ctrl.totalResults" max-size="5" boundary-links="true" ng-change="$ctrl.searchTokens($ctrl.currentPage)">
                </ul>
            </div>

            <table class="table no-margin table-striped" id="refresh_token_list">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Client</th>
                        <th>User</th>
                        <th>Value</th>
                        <th>Expires</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="token in $ctrl.tokens">

                        <td class="align-middle" id="{{token.id}}">
                            <h5>{{$index + $ctrl.currentOffset}}</h5>
                        </td>
                        <td class="align-middle">
                            <h5><a ui-sref="client({id: token.client.id})">{{token.client.clientId}}</a></h5>
                        </td>
                        <td class="align-middle" ng-if="token.user != null">
                            <a ui-sref="user({id: token.user.id})">{{token.user.userName}}</a>
                            <br/>
                            <small>{{token.user.id}}</small>
                        </td>
                        <td class="align-middle" ng-if="token.user == null">
                            <h5><small><i>This is a client specific token, not bound to a user.</i></small></h5>
                        </td>
                        <td class="align-middle">
                            <div class="input-group ">
                                <input id="token_value" type="text" class="form-control" size=40 value="{{token.value}}" readonly />
                                <span class="input-group-btn">
                                    <button class="btn btn-default" type="button" title="Copy to Clipboard" ng-click="$ctrl.copyToClipboard(token.value)"><i class="fa fa-clipboard"></i></button>
                                </span>
                            </div>
                        </td>
                        <td class="align-middle">
                            <h5 ng-if="token.expiration != null">{{token.expiration | relativeDate}}</h5>
                            <h5 ng-if="token.expiration == null">Never</h5>
                        </td>
                        <td class="align-middle text-right">
                            <button class="btn btn-xs btn-danger" ng-click="$ctrl.openRevokeRefreshTokenDialog(token)" id="revoke_{{token.value}}">
                                <i class="fa fa-times"></i> Revoke
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="text-center">
                <ul id="rtoken_pagination_bottom" uib-pagination ng-model="$ctrl.currentPage" items-per-page="$ctrl.itemsPerPage" total-items="$ctrl.totalResults" max-size="5" boundary-links="true" ng-change="$ctrl.searchTokens($ctrl.currentPage)">
                </ul>
            </div>
        </div>
    </div>
    <div class="box-footer">

    </div>
</div>